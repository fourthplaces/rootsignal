{% extends "base.html" %}

{% block title %}Map{% endblock %}

{% block extra_style %}
#map { height: calc(100vh - 56px); margin: 0; border-radius: 0; border: none; }
.container { padding: 0; max-width: none; }
{% endblock %}

{% block content %}
<div class="container">
    <div id="map"></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([44.9778, -93.2650], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
    maxZoom: 18,
}).addTo(map);

const colors = {
    Event: '#1565c0',
    Give: '#2e7d32',
    Ask: '#e65100',
    Tension: '#c62828',
};

function loadMarkers() {
    const bounds = map.getBounds();
    const center = bounds.getCenter();
    const radius = Math.min(center.distanceTo(bounds.getNorthEast()) / 1000, 50);

    fetch(`/api/nodes/near?lat=${center.lat}&lng=${center.lng}&radius=${radius}`)
        .then(r => r.json())
        .then(data => {
            data.features.forEach(f => {
                const props = f.properties;
                const [lng, lat] = f.geometry.coordinates;
                const color = colors[props.node_type] || '#999';

                const marker = L.circleMarker([lat, lng], {
                    radius: 7,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 0.85,
                });

                marker.bindPopup(`
                    <strong>${props.title}</strong><br>
                    <span style="color:${color};font-weight:600;font-size:11px">${props.node_type}</span><br>
                    <span style="font-size:12px;color:#555">${props.summary.substring(0, 120)}...</span><br>
                    <a href="/nodes/${props.id}" style="font-size:12px">View details</a>
                `);

                marker.addTo(map);
            });
        });
}

map.on('moveend', loadMarkers);
loadMarkers();
</script>
{% endblock %}
