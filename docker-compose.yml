services:
  neo4j:
    hostname: neo4j
    image: neo4j:5.25.1-enterprise
    ports:
      - "7474:7474"   # HTTP browser
      - "7687:7687"   # Bolt
    environment:
      NEO4J_AUTH: neo4j/rootsignal
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
      NEO4J_PLUGINS: '["graph-data-science"]'
      NEO4J_dbms_security_procedures_unrestricted: gds.*
      NEO4J_dbms_security_procedures_allowlist: gds.*
    volumes:
      - neo4j-data:/data
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p rootsignal 'RETURN 1'"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s

  postgres:
    image: postgres:16
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: rootsignal
      POSTGRES_PASSWORD: rootsignal
      POSTGRES_DB: rootsignal
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rootsignal"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  restate:
    image: docker.io/restatedev/restate:latest
    ports:
      - "8080:8080"   # ingress
      - "9070:9070"   # admin
      - "9071:9071"   # metrics
    environment:
      RESTATE_OBSERVABILITY__LOG__FORMAT: compact
      RESTATE_OBSERVABILITY__LOG__FILTER: info,restate=debug
    volumes:
      - restate-data:/target/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9070/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

  browserless:
    image: browserless/chrome
    restart: unless-stopped
    environment:
      MAX_CONCURRENT_SESSIONS: 5
      CONNECTION_TIMEOUT: 30000

  api:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "3001:3000"
      - "9080:9080"   # Restate endpoint
    depends_on:
      neo4j:
        condition: service_healthy
      postgres:
        condition: service_healthy
      restate:
        condition: service_healthy
    volumes:
      - ./Cargo.toml:/app/Cargo.toml
      - ./Cargo.lock:/app/Cargo.lock
      - ./modules:/app/modules
      - cargo-registry:/usr/local/cargo/registry
      - cargo-target:/app/target
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: rootsignal
      DATABASE_URL: postgres://rootsignal:rootsignal@postgres:5432/rootsignal
      ADMIN_PASSWORD: admin
      ADMIN_NUMBERS: "+1234567890"
      RUST_LOG: info
      API_HOST: "0.0.0.0"
      API_PORT: "3000"
      RESTATE_PORT: "9080"
      RESTATE_ADMIN_URL: http://restate:9070
      RESTATE_SELF_URL: http://api:9080
      RESTATE_INGRESS_URL: http://restate:8080
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      VOYAGE_API_KEY: ${VOYAGE_API_KEY:-}
      SERPER_API_KEY: ${SERPER_API_KEY:-}
      APIFY_API_KEY: ${APIFY_API_KEY:-}
      REGION: ${REGION:-${CITY:-twincities}}
      BROWSERLESS_URL: http://browserless:3000

  admin-app:
    image: node:22-slim
    ports:
      - "5173:5173"
    depends_on:
      - api
    volumes:
      - ./modules/admin-app:/app
      - admin-node-modules:/app/node_modules
    working_dir: /app
    environment:
      NODE_ENV: development
      API_URL: http://api:3000
      VITE_MAPBOX_TOKEN: ${MAPBOX_TOKEN:-}
    command: ["sh", "-c", "npm install && npm run dev"]

  search-app:
    image: node:22-slim
    ports:
      - "5174:5174"
    depends_on:
      - api
    volumes:
      - ./modules/search-app:/app
      - search-node-modules:/app/node_modules
    working_dir: /app
    environment:
      NODE_ENV: development
      API_URL: http://api:3000
      VITE_MAPBOX_TOKEN: ${MAPBOX_TOKEN:-}
    command: ["sh", "-c", "npm install && npm run dev"]

  scout:
    build:
      context: .
      dockerfile: Dockerfile.dev
    init: true
    profiles: [scout]
    depends_on:
      neo4j:
        condition: service_healthy
      postgres:
        condition: service_healthy
    volumes:
      - ./Cargo.toml:/app/Cargo.toml
      - ./Cargo.lock:/app/Cargo.lock
      - ./modules:/app/modules
      - cargo-registry:/usr/local/cargo/registry
      - cargo-target:/app/target
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: rootsignal
      DATABASE_URL: postgres://rootsignal:rootsignal@postgres:5432/rootsignal
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      VOYAGE_API_KEY: ${VOYAGE_API_KEY}
      SERPER_API_KEY: ${SERPER_API_KEY}
      APIFY_API_KEY: ${APIFY_API_KEY:-}
      REGION: ${REGION:-${CITY:-twincities}}
      BROWSERLESS_URL: http://browserless:3000
      RUST_LOG: info,html5ever=off
    command: ["cargo", "run", "--bin", "scout"]

volumes:
  neo4j-data:
  postgres-data:
  restate-data:
  cargo-registry:
  cargo-target:
  admin-node-modules:
  search-node-modules:
