services:
  postgres:
    image: pgvector/pgvector:pg16
    labels:
      dev.description: "PostgreSQL database with pgvector"
      dev.shell: "bash"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: rootsignal
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  restate:
    image: docker.io/restatedev/restate:1.1
    labels:
      dev.description: "Restate durable workflow runtime"
    ports:
      - "8080:8080"   # Ingress
      - "9070:9070"   # Admin
      - "9071:9071"   # Metrics
    environment:
      - RESTATE_LOG_FILTER=info

  rootsignal-server:
    build:
      context: .
      dockerfile: Dockerfile.dev
    labels:
      dev.description: "Root Signal API server"
      dev.shell: "bash"
    ports:
      - "9080:9080"   # Restate worker
      - "9081:9081"   # GraphQL / REST API
    depends_on:
      postgres:
        condition: service_healthy
      restate:
        condition: service_started
    volumes:
      - ./Cargo.toml:/app/Cargo.toml
      - ./Cargo.lock:/app/Cargo.lock
      - ./modules/rootsignal-server:/app/modules/rootsignal-server
      - ./modules/rootsignal-domains:/app/modules/rootsignal-domains
      - ./modules/rootsignal-core:/app/modules/rootsignal-core
      - ./modules/ai-client:/app/modules/ai-client
      - ./modules/apify-client:/app/modules/apify-client
      - ./modules/twilio-rs:/app/modules/twilio-rs
      - ./migrations:/app/migrations
      - ./config:/app/config
      - cargo-registry:/usr/local/cargo/registry
      - cargo-target:/app/target
    environment:
      # Database
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/rootsignal

      # Server
      PORT: "9080"
      RESTATE_ADMIN_URL: http://restate:9070
      RESTATE_SELF_URL: http://rootsignal-server:9080
      ALLOWED_ORIGINS: http://localhost:3000

      # API Keys
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      TAVILY_API_KEY: ${TAVILY_API_KEY}
      FIRECRAWL_API_KEY: ${FIRECRAWL_API_KEY:-}

      # Auth
      JWT_SECRET: ${JWT_SECRET:-dev-secret-change-in-production}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_VERIFY_SERVICE_SID: ${TWILIO_VERIFY_SERVICE_SID:-}
      ADMIN_PHONE_NUMBERS: ${ADMIN_PHONE_NUMBERS:-}
      TEST_IDENTIFIER_ENABLED: ${TEST_IDENTIFIER_ENABLED:-true}

  admin-app:
    build:
      context: .
      dockerfile: modules/admin-app/Dockerfile.dev
    labels:
      dev.description: "Next.js admin frontend"
      dev.shell: "sh"
    ports:
      - "3000:3000"
    depends_on:
      - rootsignal-server
    volumes:
      - ./modules/admin-app:/app/modules/admin-app
      - ./modules/api-client-js:/app/modules/api-client-js
      - /app/modules/admin-app/node_modules
      - /app/modules/api-client-js/node_modules
      - /app/node_modules
    environment:
      NEXT_PUBLIC_GRAPHQL_URL: http://localhost:9081/graphql
      GRAPHQL_URL: http://rootsignal-server:9081/graphql
      WATCHPACK_POLLING: "true"

volumes:
  pgdata:
  cargo-registry:
  cargo-target:
